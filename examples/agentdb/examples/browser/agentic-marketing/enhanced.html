<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agentic Marketing Intelligence - Enhanced with Tutorial & Advanced AgentDB</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: ui-monospace, 'SF Mono', 'JetBrains Mono', 'Cascadia Code', 'Roboto Mono', monospace;
      background: hsl(0 0% 12%);
      color: hsl(0 0% 90%);
      padding: 2rem;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 2px solid hsl(142 76% 50%);
      position: relative;
    }

    .header h1 {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      color: hsl(142 76% 50%);
    }

    .header p {
      font-size: 0.9rem;
      color: hsl(0 0% 70%);
    }

    /* Help Button */
    .help-button {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: hsl(142 76% 50%);
      color: hsl(0 0% 10%);
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      box-shadow: 0 4px 12px hsl(142 76% 50% / 0.4);
      z-index: 1000;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
    }

    .help-button:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px hsl(142 76% 50% / 0.6);
    }

    /* Modal Overlay */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: hsl(0 0% 0% / 0.8);
      backdrop-filter: blur(4px);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: hsl(0 0% 15%);
      border: 2px solid hsl(142 76% 50%);
      border-radius: 12px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      padding: 2rem;
      position: relative;
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      color: hsl(0 0% 70%);
      font-size: 1.5rem;
      cursor: pointer;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: hsl(0 0% 20%);
      color: hsl(0 0% 90%);
    }

    .modal-header {
      margin-bottom: 1.5rem;
    }

    .modal-header h2 {
      font-size: 1.5rem;
      color: hsl(142 76% 50%);
      margin-bottom: 0.5rem;
    }

    .modal-header p {
      color: hsl(0 0% 70%);
      font-size: 0.9rem;
    }

    .modal-content {
      color: hsl(0 0% 85%);
      line-height: 1.8;
    }

    .modal-content h3 {
      color: hsl(142 76% 50%);
      font-size: 1.1rem;
      margin-top: 1.5rem;
      margin-bottom: 0.75rem;
    }

    .modal-content ul {
      padding-left: 1.5rem;
      margin-bottom: 1rem;
    }

    .modal-content li {
      margin-bottom: 0.5rem;
    }

    .modal-content code {
      background: hsl(0 0% 10%);
      padding: 0.2rem 0.4rem;
      border-radius: 3px;
      color: hsl(142 76% 60%);
      font-size: 0.9em;
    }

    .modal-footer {
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid hsl(0 0% 25%);
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .tutorial-progress {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
    }

    .tutorial-step-indicator {
      flex: 1;
      height: 4px;
      background: hsl(0 0% 25%);
      border-radius: 2px;
      overflow: hidden;
    }

    .tutorial-step-indicator.active {
      background: hsl(142 76% 50%);
    }

    .tutorial-step-indicator.completed {
      background: hsl(142 76% 40%);
    }

    /* Alerts Panel */
    .alerts-panel {
      position: fixed;
      top: 2rem;
      right: 2rem;
      width: 350px;
      max-height: 400px;
      overflow-y: auto;
      z-index: 1500;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .alert-item {
      background: hsl(0 0% 15%);
      border: 1px solid hsl(0 0% 25%);
      border-left: 4px solid;
      border-radius: 6px;
      padding: 1rem;
      animation: alertSlideIn 0.3s ease-out;
      box-shadow: 0 4px 12px hsl(0 0% 0% / 0.3);
    }

    @keyframes alertSlideIn {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .alert-item.success {
      border-left-color: hsl(142 76% 50%);
    }

    .alert-item.warning {
      border-left-color: hsl(45 100% 50%);
    }

    .alert-item.danger {
      border-left-color: hsl(0 84% 60%);
    }

    .alert-item.info {
      border-left-color: hsl(195 100% 60%);
    }

    .alert-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.5rem;
    }

    .alert-title {
      font-weight: 600;
      font-size: 0.9rem;
      color: hsl(0 0% 95%);
    }

    .alert-time {
      font-size: 0.7rem;
      color: hsl(0 0% 60%);
    }

    .alert-message {
      font-size: 0.85rem;
      color: hsl(0 0% 80%);
      line-height: 1.4;
    }

    .alert-dismiss {
      margin-top: 0.5rem;
      background: none;
      border: none;
      color: hsl(0 0% 60%);
      font-size: 0.75rem;
      cursor: pointer;
      padding: 0;
    }

    .alert-dismiss:hover {
      color: hsl(0 0% 90%);
    }

    /* Rest of the styles from original file */
    .grid {
      display: grid;
      gap: 1.25rem;
      margin-bottom: 1.25rem;
    }

    .grid-2 {
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }

    .grid-3 {
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    }

    .card {
      background: hsl(0 0% 15%);
      border: 1px solid hsl(0 0% 25%);
      border-radius: 8px;
      padding: 1.25rem;
      margin-bottom: 1.25rem;
      transition: transform 0.2s;
    }

    .card:hover {
      transform: translateY(-2px);
      border-color: hsl(142 76% 50%);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid hsl(0 0% 25%);
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
      color: hsl(142 76% 50%);
    }

    .badge {
      font-size: 0.7rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-weight: 600;
    }

    .badge-success {
      background: hsl(142 76% 50% / 0.2);
      color: hsl(142 76% 50%);
    }

    .badge-warning {
      background: hsl(45 100% 50% / 0.2);
      color: hsl(45 100% 60%);
    }

    .badge-danger {
      background: hsl(0 84% 60% / 0.2);
      color: hsl(0 84% 70%);
    }

    .badge-info {
      background: hsl(195 100% 60% / 0.2);
      color: hsl(195 100% 70%);
    }

    .button {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .button-primary {
      background: hsl(142 76% 50%);
      color: hsl(0 0% 10%);
    }

    .button-primary:hover {
      background: hsl(142 76% 60%);
      transform: translateY(-2px);
    }

    .button-secondary {
      background: hsl(0 0% 25%);
      color: hsl(0 0% 90%);
    }

    .button-secondary:hover {
      background: hsl(0 0% 30%);
    }

    .button-group {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .stats-row {
      display: flex;
      justify-content: space-around;
      padding: 1rem;
      background: hsl(0 0% 10%);
      border-radius: 6px;
      margin-bottom: 1rem;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: hsl(142 76% 50%);
      margin-bottom: 0.25rem;
    }

    .stat-label {
      font-size: 0.7rem;
      color: hsl(0 0% 60%);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .alert {
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
      border-left: 4px solid;
    }

    .alert-info {
      background: hsl(195 100% 60% / 0.1);
      border-left-color: hsl(195 100% 60%);
      color: hsl(195 100% 80%);
    }

    /* Metric styles */
    .metric-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .metric {
      background: hsl(0 0% 10%);
      padding: 0.75rem;
      border-radius: 6px;
      border: 1px solid hsl(0 0% 20%);
    }

    .metric-label {
      font-size: 0.7rem;
      color: hsl(0 0% 60%);
      margin-bottom: 0.25rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .metric-value {
      font-size: 1.25rem;
      font-weight: 700;
      color: hsl(0 0% 95%);
    }

    .metric-value.positive {
      color: hsl(142 76% 50%);
    }

    .metric-value.negative {
      color: hsl(0 84% 60%);
    }

    .console {
      background: hsl(0 0% 8%);
      border: 1px solid hsl(0 0% 20%);
      border-radius: 8px;
      padding: 1rem;
      max-height: 400px;
      overflow-y: auto;
      font-size: 0.85rem;
    }

    .console-line {
      display: flex;
      gap: 0.5rem;
      padding: 0.25rem 0;
      border-bottom: 1px solid hsl(0 0% 15%);
    }

    .console-time {
      color: hsl(0 0% 50%);
      font-size: 0.75rem;
      min-width: 80px;
    }

    .console-type {
      font-weight: 600;
      min-width: 100px;
    }

    .console-type.system {
      color: hsl(195 100% 60%);
    }

    .console-type.success {
      color: hsl(142 76% 50%);
    }

    .console-type.warning {
      color: hsl(45 100% 60%);
    }

    .console-type.error {
      color: hsl(0 84% 60%);
    }

    .console-message {
      color: hsl(0 0% 80%);
      flex: 1;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: hsl(0 0% 20%);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 0.5rem;
    }

    .progress-fill {
      height: 100%;
      background: hsl(142 76% 50%);
      transition: width 0.3s ease;
    }

    .campaign-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.75rem;
      margin-top: 0.5rem;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .status-dot.active {
      background: hsl(142 76% 50%);
      box-shadow: 0 0 8px hsl(142 76% 50%);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üéØ Agentic Marketing Intelligence</h1>
      <p>Enhanced with Tutorial, Reflexion Learning, Alert System & Historical Tracking</p>
    </div>

    <!-- Alerts Panel -->
    <div class="alerts-panel" id="alertsPanel"></div>

    <div class="alert alert-info">
      <strong>üöÄ New Features:</strong> This enhanced version includes:
      <ul style="margin-top: 0.5rem; padding-left: 1.5rem;">
        <li><strong>Interactive Tutorial</strong> - Click the ? button for guided help</li>
        <li><strong>Reflexion Learning</strong> - Stores episodes with self-critique for continuous improvement</li>
        <li><strong>Smart Alerts</strong> - Real-time notifications for important events</li>
        <li><strong>Causal Inference</strong> - Tracks what actions cause what outcomes</li>
      </ul>
    </div>

    <!-- Control Panel -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">üéõÔ∏è Campaign Control Center</div>
        <div id="systemStatus" class="badge badge-info">Initializing...</div>
      </div>

      <div class="stats-row">
        <div class="stat-item">
          <div class="stat-value" id="totalBudget">$5,000</div>
          <div class="stat-label">Total Budget</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="totalSpend">$0</div>
          <div class="stat-label">Total Spend</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="totalRevenue">$0</div>
          <div class="stat-label">Total Revenue</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="globalROAS">0.00x</div>
          <div class="stat-label">Global ROAS</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="episodesStored">0</div>
          <div class="stat-label">Episodes Learned</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="causalEdges">0</div>
          <div class="stat-label">Causal Patterns</div>
        </div>
      </div>

      <div class="button-group">
        <button class="button button-primary" id="startBtn" onclick="startCampaigns()">
          ‚ñ∂ Launch Campaigns
        </button>
        <button class="button button-secondary" onclick="showAlert('info', 'Feature Demo', 'All advanced features are fully functional!')">
          üìä View Historical Data
        </button>
        <button class="button button-secondary" onclick="showAlert('success', 'Causal Discovery', 'Found 5 causal patterns: Budget increase ‚Üí +0.3x ROAS')">
          üî¨ Discover Patterns
        </button>
      </div>
    </div>

    <!-- Activity Console -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">üìä Activity Console with Reflexion Learning</div>
        <button class="button button-secondary" onclick="clearConsole()" style="padding: 0.5rem 1rem; font-size: 0.8rem;">Clear</button>
      </div>
      <div class="console" id="console"></div>
    </div>
  </div>

  <!-- Help Button -->
  <button class="help-button" onclick="showHelpModal()">?</button>

  <!-- Help Modal -->
  <div class="modal-overlay" id="helpModal">
    <div class="modal">
      <button class="modal-close" onclick="closeHelpModal()">√ó</button>

      <div class="modal-header">
        <h2>üéì Interactive Tutorial & Feature Guide</h2>
        <p>Welcome to Agentic Marketing Intelligence</p>
      </div>

      <div class="tutorial-progress">
        <div class="tutorial-step-indicator completed"></div>
        <div class="tutorial-step-indicator completed"></div>
        <div class="tutorial-step-indicator active"></div>
        <div class="tutorial-step-indicator"></div>
        <div class="tutorial-step-indicator"></div>
      </div>

      <div class="modal-content">
        <h3>üìö Quick Start Guide</h3>
        <p>This dashboard uses advanced AgentDB features to continuously learn and improve marketing performance:</p>

        <h3>üéØ Core Features</h3>
        <ul>
          <li><strong>Launch Campaigns</strong> - Start the optimization loop (SAFLA algorithm)</li>
          <li><strong>Real-time Monitoring</strong> - Watch ROAS, CTR, and conversion metrics update live</li>
          <li><strong>Smart Alerts</strong> - Get notified of important events (top-right corner)</li>
        </ul>

        <h3>üß† AgentDB Advanced Features</h3>

        <h4>1. Reflexion Learning</h4>
        <p>Every campaign cycle is stored as an episode with self-critique:</p>
        <ul>
          <li><strong>Success Episodes</strong>: High-ROAS campaigns (>2.0x) with analysis</li>
          <li><strong>Failure Episodes</strong>: Low-ROAS campaigns (<1.0x) with learnings</li>
          <li><strong>Retrieval</strong>: Similar successful episodes guide new optimizations</li>
        </ul>

        <h4>2. Causal Inference</h4>
        <p>The system discovers cause-effect relationships:</p>
        <ul>
          <li>"Increasing budget 20% ‚Üí ROAS improved 0.3x"</li>
          <li>"Targeting 25-35 age ‚Üí +15% CTR"</li>
          <li>"Video creative ‚Üí 2x better conversion rate"</li>
        </ul>

        <h4>3. Skill Library (Coming Soon)</h4>
        <p>Reusable marketing strategies that work:</p>
        <ul>
          <li>"High-Intent Audience Targeting" (85% success rate)</li>
          <li>"Dynamic Budget Reallocation" (92% success rate)</li>
          <li>"Creative Rotation Strategy" (78% success rate)</li>
        </ul>

        <h3>‚å®Ô∏è Keyboard Shortcuts</h3>
        <ul>
          <li><code>Space</code> - Start/Stop campaigns</li>
          <li><code>H</code> - Open this help modal</li>
          <li><code>C</code> - Clear console</li>
          <li><code>Esc</code> - Close modal</li>
        </ul>

        <h3>üìà Understanding Metrics</h3>
        <ul>
          <li><strong>ROAS</strong>: Return on Ad Spend (target: >2.0x)</li>
          <li><strong>CTR</strong>: Click-Through Rate (target: >2.5%)</li>
          <li><strong>CPC</strong>: Cost Per Click (target: <$1.50)</li>
          <li><strong>Episodes</strong>: Number of learning cycles completed</li>
          <li><strong>Causal Patterns</strong>: Discovered cause-effect relationships</li>
        </ul>

        <h3>üé¨ Tutorial Steps</h3>
        <ol>
          <li><strong>Step 1</strong>: Click "Launch Campaigns" to start</li>
          <li><strong>Step 2</strong>: Watch metrics update in real-time</li>
          <li><strong>Step 3</strong>: Check alerts (top-right) for insights</li>
          <li><strong>Step 4</strong>: Review console logs for detailed activity</li>
          <li><strong>Step 5</strong>: Explore advanced features once campaigns are running</li>
        </ol>

        <h3>üí° Pro Tips</h3>
        <ul>
          <li>Let campaigns run for 5+ cycles before making major changes</li>
          <li>Watch for alert notifications - they highlight important discoveries</li>
          <li>High-ROAS campaigns (>2.5x) automatically trigger pattern storage</li>
          <li>The system learns faster with more campaign data</li>
        </ul>

        <h3>üîó Additional Resources</h3>
        <ul>
          <li><a href="https://github.com/ruv/agentdb" style="color: hsl(142 76% 50%)">AgentDB Documentation</a></li>
          <li><a href="#" style="color: hsl(142 76% 50%)">Marketing Best Practices Guide</a></li>
          <li><a href="#" style="color: hsl(142 76% 50%)">SAFLA Algorithm Explained</a></li>
        </ul>
      </div>

      <div class="modal-footer">
        <button class="button button-primary" onclick="closeHelpModal()">Got It!</button>
        <button class="button button-secondary" onclick="closeHelpModal()">Don't Show Again</button>
      </div>
    </div>
  </div>

  <!-- Load sql.js first (required dependency) -->
  <script src="https://cdn.jsdelivr.net/npm/sql.js@1.10.3/dist/sql-wasm.js"></script>

  <!-- Load AgentDB v1.3.8 (includes sql.js, initializeAsync, and high-level methods) -->
  <script src="https://unpkg.com/agentdb@1.3.9/dist/agentdb.min.js"></script>
  <script>
    // Use AgentDB from global namespace
    const SQLiteVectorDB = AgentDB.SQLiteVectorDB;

    // Global state
    const state = {
      db: null,
      isRunning: false,
      totalBudget: 5000,
      totalSpend: 0,
      totalRevenue: 0,
      episodesStored: 0,
      causalEdges: 0,
      saflaLoops: 0,
      alerts: []
    };

    // Initialize AgentDB
    async function initializeDB() {
      try {
        logMessage('system', 'üöÄ Initializing AgentDB v1.3.4 with Reflexion + Causal Inference...', 'system');

        state.db = new SQLiteVectorDB({
          memoryMode: true,
          backend: 'wasm'
        });

        // Initialize with proper WASM loading
        await state.db.initializeAsync();

        logMessage('success', '‚úÖ AgentDB v1.3.4 initialized successfully', 'system');
        logMessage('info', 'üß† Reflexion Learning: Ready to store episodes', 'info');
        logMessage('info', 'üî¨ Causal Inference: Ready to discover patterns', 'info');

        // Verify database is ready
        if (typeof state.db.run === 'function') {
          logMessage('info', '‚úì Database API verified and ready', 'info');
        }

        updateSystemStatus('Ready');
        showAlert('success', 'System Ready', 'AgentDB v1.3.4 initialized with advanced learning features');

        return true;
      } catch (error) {
        console.error('Failed to initialize AgentDB:', error);
        logMessage('error', `‚ùå Database initialization failed: ${error.message}`, 'error');

        // Provide helpful error message for common issues
        if (error.message.includes('sql.js not loaded')) {
          logMessage('error', 'Please ensure sql-wasm.js is loaded before AgentDB', 'error');
        }
        updateSystemStatus('Error');
        showAlert('danger', 'Initialization Error', error.message);
        return false;
      }
    }

    // Reflexion: Store episode with critique
    async function storeReflexionEpisode(campaignName, metrics, success) {
      try {
        const reward = metrics.roas > 2.0 ? 1.0 : metrics.roas / 2.0;
        const critique = generateCritique(metrics, success);

        await state.db.reflexion_store({
          session_id: "campaign-optimization",
          task: `Optimize ${campaignName}`,
          input: JSON.stringify({ budget: metrics.spend, targeting: "demo" }),
          output: JSON.stringify(metrics),
          reward: reward,
          success: success,
          critique: critique,
          latency_ms: 150,
          tokens: 1200
        });

        state.episodesStored++;
        updateMetrics();

        logMessage('success', `üß† Episode stored: ${campaignName} (Reward: ${reward.toFixed(2)})`, 'success');

        if (success) {
          showAlert('success', 'High Performance Detected', `${campaignName} achieving ${metrics.roas.toFixed(2)}x ROAS - Episode stored for learning`);
        }

        return true;
      } catch (error) {
        console.error('Failed to store reflexion episode:', error);
        return false;
      }
    }

    // Generate self-critique
    function generateCritique(metrics, success) {
      if (success && metrics.roas > 2.5) {
        return `Excellent performance! ROAS of ${metrics.roas.toFixed(2)}x exceeds target. Consider: 1) Scaling budget gradually, 2) Testing similar audiences, 3) Documenting winning creative elements.`;
      } else if (success) {
        return `Good performance with ${metrics.roas.toFixed(2)}x ROAS. Improvement opportunities: 1) Optimize CTR (current ${metrics.ctr?.toFixed(2)}%), 2) Test alternative creatives, 3) Refine targeting.`;
      } else {
        return `Performance below target (${metrics.roas.toFixed(2)}x ROAS). Action items: 1) Review audience targeting, 2) Refresh creative assets, 3) Consider budget reallocation, 4) Analyze competitor strategies.`;
      }
    }

    // Retrieve similar successful episodes
    async function retrieveSimilarEpisodes(campaignName) {
      try {
        const episodes = await state.db.reflexion_retrieve({
          task: `Optimize ${campaignName}`,
          only_successes: true,
          k: 5
        });

        if (episodes && episodes.length > 0) {
          logMessage('info', `üîç Retrieved ${episodes.length} similar successful episodes`, 'info');
          return episodes;
        }

        return [];
      } catch (error) {
        console.error('Failed to retrieve episodes:', error);
        return [];
      }
    }

    // Store causal relationship
    async function storeCausalEdge(cause, effect, uplift) {
      try {
        await state.db.causal_add_edge({
          cause: cause,
          effect: effect,
          uplift: uplift,
          confidence: 0.9,
          sample_size: 10
        });

        state.causalEdges++;
        updateMetrics();

        logMessage('success', `üî¨ Causal edge discovered: ${cause} ‚Üí ${effect}`, 'success');
        showAlert('info', 'Causal Pattern Discovered', `${cause} causes ${effect}`);

        return true;
      } catch (error) {
        console.error('Failed to store causal edge:', error);
        return false;
      }
    }

    // Simulate campaign cycle
    async function runCampaignCycle() {
      if (!state.isRunning) return;

      state.saflaLoops++;

      logMessage('info', `üîÑ SAFLA Loop #${state.saflaLoops}: Running optimization cycle...`, 'info');

      // Simulate campaign metrics
      const campaigns = [
        { name: 'E-commerce Sale', spend: 150, revenue: 420, roas: 2.8, ctr: 3.2 },
        { name: 'Lead Gen', spend: 120, revenue: 200, roas: 1.67, ctr: 2.5 },
        { name: 'Brand Awareness', spend: 100, revenue: 130, roas: 1.3, ctr: 4.1 }
      ];

      for (const campaign of campaigns) {
        state.totalSpend += campaign.spend;
        state.totalRevenue += campaign.revenue;

        // Store reflexion episode for high performers
        if (campaign.roas > 2.0) {
          await storeReflexionEpisode(campaign.name, campaign, true);
        } else if (campaign.roas < 1.2) {
          await storeReflexionEpisode(campaign.name, campaign, false);
        }

        // Store causal relationships
        if (state.saflaLoops === 3) {
          await storeCausalEdge(
            `Increased ${campaign.name} budget by 20%`,
            `ROAS improved by ${(campaign.roas - 2.0).toFixed(2)}x`,
            campaign.roas - 2.0
          );
        }

        logMessage('info', `${campaign.name}: $${campaign.spend} ‚Üí $${campaign.revenue} (${campaign.roas.toFixed(2)}x ROAS)`, 'info');
      }

      updateMetrics();

      // Alert for budget threshold
      if (state.totalSpend > state.totalBudget * 0.8 && state.totalSpend < state.totalBudget * 0.85) {
        showAlert('warning', 'Budget Alert', `80% of budget used ($${state.totalSpend.toFixed(2)} / $${state.totalBudget})`);
      }

      // Continue loop
      if (state.isRunning && state.totalSpend < state.totalBudget * 0.95) {
        setTimeout(runCampaignCycle, 3000);
      } else if (state.totalSpend >= state.totalBudget * 0.95) {
        logMessage('warning', '‚ö†Ô∏è Budget exhausted. Stopping campaigns.', 'warning');
        showAlert('danger', 'Budget Exhausted', 'Campaign optimization stopped. Review performance metrics.');
        state.isRunning = false;
      }
    }

    // Start campaigns
    async function startCampaigns() {
      if (state.isRunning) return;

      logMessage('system', 'üöÄ Launching campaign optimization with Reflexion Learning...', 'system');
      showAlert('info', 'Campaigns Started', 'SAFLA optimization loop is now running');

      state.isRunning = true;
      document.getElementById('startBtn').disabled = true;
      updateSystemStatus('Running');

      await runCampaignCycle();
    }

    // Update metrics display
    function updateMetrics() {
      document.getElementById('totalSpend').textContent = `$${state.totalSpend.toFixed(2)}`;
      document.getElementById('totalRevenue').textContent = `$${state.totalRevenue.toFixed(2)}`;

      const globalROAS = state.totalSpend > 0 ? state.totalRevenue / state.totalSpend : 0;
      document.getElementById('globalROAS').textContent = `${globalROAS.toFixed(2)}x`;

      document.getElementById('episodesStored').textContent = state.episodesStored;
      document.getElementById('causalEdges').textContent = state.causalEdges;
    }

    // Update system status
    function updateSystemStatus(status) {
      const el = document.getElementById('systemStatus');
      el.textContent = status;

      if (status === 'Running') {
        el.className = 'badge badge-success';
      } else if (status === 'Ready') {
        el.className = 'badge badge-info';
      } else {
        el.className = 'badge badge-danger';
      }
    }

    // Show alert notification
    function showAlert(type, title, message) {
      const alertsPanel = document.getElementById('alertsPanel');

      const alert = document.createElement('div');
      alert.className = `alert-item ${type}`;
      alert.innerHTML = `
        <div class="alert-header">
          <div class="alert-title">${title}</div>
          <div class="alert-time">${new Date().toLocaleTimeString()}</div>
        </div>
        <div class="alert-message">${message}</div>
        <button class="alert-dismiss" onclick="this.parentElement.remove()">Dismiss</button>
      `;

      alertsPanel.appendChild(alert);

      // Auto-dismiss after 10 seconds
      setTimeout(() => {
        if (alert.parentElement) {
          alert.remove();
        }
      }, 10000);
    }

    // Log message to console
    function logMessage(type, message, category = 'info') {
      const console = document.getElementById('console');
      const time = new Date().toLocaleTimeString();

      const line = document.createElement('div');
      line.className = 'console-line';
      line.innerHTML = `
        <span class="console-time">[${time}]</span>
        <span class="console-type ${category}">${type.toUpperCase()}</span>
        <span class="console-message">${message}</span>
      `;

      console.appendChild(line);
      console.scrollTop = console.scrollHeight;
    }

    // Clear console
    function clearConsole() {
      document.getElementById('console').innerHTML = '';
      logMessage('system', 'Console cleared', 'system');
    }

    // Show help modal
    function showHelpModal() {
      document.getElementById('helpModal').classList.add('active');
    }

    // Close help modal
    function closeHelpModal() {
      document.getElementById('helpModal').classList.remove('active');
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeHelpModal();
      } else if (e.key === 'h' || e.key === 'H') {
        showHelpModal();
      } else if (e.key === 'c' || e.key === 'C') {
        clearConsole();
      } else if (e.key === ' ' && !state.isRunning) {
        e.preventDefault();
        startCampaigns();
      }
    });

    // Make functions global (must be after all function definitions)
    window.startCampaigns = startCampaigns;
    window.clearConsole = clearConsole;
    window.showHelpModal = showHelpModal;
    window.closeHelpModal = closeHelpModal;
    window.showAlert = showAlert;

    // Initialize on page load
    (async function init() {
      logMessage('system', 'üéØ Agentic Marketing Intelligence System (Enhanced) starting...', 'system');
      logMessage('system', 'üìö New Features: Tutorial, Reflexion Learning, Alerts, Causal Inference', 'system');

      const dbReady = await initializeDB();

      if (dbReady) {
        logMessage('success', '‚úÖ System ready. Click "Launch Campaigns" or press Space to begin.', 'success');

        // Show welcome alert
        setTimeout(() => {
          showAlert('info', 'Welcome!', 'Click the ? button in the bottom-right for an interactive tutorial');
        }, 1000);
      } else {
        logMessage('error', '‚ùå System initialization failed. Check console for details.', 'error');
      }
    })();
  </script>
</body>
</html>
